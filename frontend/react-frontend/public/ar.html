<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>AR World â€” Improved Tree + Rewards</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- A-Frame & AR.js -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
      body,html { margin:0; padding:0; height:100%; overflow:hidden; background:#000; }
      #hint { position:fixed; top:8px; left:8px; background:#fff; padding:6px 10px; border-radius:6px; font-family:sans-serif; font-size:14px; z-index:5; }
    </style>
  </head>
  <body>
    <div id="hint">
      Point your camera at a printed <strong>hiro</strong> marker.  
      <a href="/hiro-marker.png" target="_blank">Download marker</a>
    </div>

    <a-scene embedded arjs="sourceType: webcam; debugUIEnabled: false;">
      <!-- Marker with tree + reward -->
      <a-marker preset="hiro" onmarker>
        <a-entity id="prettyTree" position="0 0 0" scale="1 1 1">
          <!-- Ground -->
          <a-circle position="0 0.01 0" rotation="-90 0 0" radius="0.9" material="color:#3b2b18; opacity:0.9"></a-circle>

          <!-- Trunk -->
          <a-cylinder position="0 0.18 0" height="0.36" radius="0.12" material="color:#6d3f1f; roughness:0.9"></a-cylinder>
          <a-cylinder position="0 0.45 0" height="0.30" radius="0.10" material="color:#6d3f1f; roughness:0.9"></a-cylinder>
          <a-cylinder position="0 0.70 0" height="0.24" radius="0.08" material="color:#6d3f1f; roughness:0.9"></a-cylinder>

          <!-- Branch -->
          <a-cone position="0.18 0.85 0" rotation="0 0 30" height="0.14" radius-bottom="0.04" material="color:#6d3f1f"></a-cone>

          <!-- Canopy -->
          <a-sphere position="0 1.25 0" radius="0.55" material="color:#2b8a3e; roughness:0.8"></a-sphere>
          <a-sphere position="-0.44 1.12 0.12" radius="0.46" material="color:#2e9b3f; roughness:0.8"></a-sphere>
          <a-sphere position="0.44 1.12 0.12" radius="0.46" material="color:#228a36; roughness:0.8"></a-sphere>
          <a-sphere position="0 1.45 0.08" radius="0.36" material="color:#34a84a; roughness:0.8"></a-sphere>

          <!-- Highlights -->
          <a-sphere position="0.15 1.32 0.35" radius="0.06" material="color:#bff2c9; opacity:0.9"></a-sphere>
          <a-sphere position="-0.18 1.18 -0.3" radius="0.05" material="color:#c8f7cf; opacity:0.9"></a-sphere>
        </a-entity>

        <!-- Floating +points label -->
        <a-text id="pointsText"
                value="+50 points"
                position="0 2 0"
                align="center"
                color="#ffd84d"
                visible="false"
                look-at="[camera]"></a-text>
      </a-marker>

      <!-- Camera + Lights -->
      <a-entity camera></a-entity>
      <a-entity light="type: ambient; intensity: 0.9"></a-entity>
      <a-entity light="type: directional; intensity: 0.8" position="0 1 0"></a-entity>
    </a-scene>

    <script>
      // Send reward to backend
      function award(type){
        const token = new URLSearchParams(location.search).get('token'); // pass token when opening /ar.html?token=XYZ
        fetch('http://localhost:5000/api/actions/complete', {
          method:'POST',
          headers:{
            'Content-Type':'application/json',
            ...(token ? { 'Authorization':'Bearer '+token } : {})
          },
          body: JSON.stringify({ type })
        }).then(r=>r.json()).then(data=>{
          console.log("Backend response:", data);
        }).catch(err=>console.error("Award failed",err));
      }

      // Custom component to hook marker detection
      AFRAME.registerComponent('onmarker', {
        init: function(){
          const el = this.el;
          const pointsText = document.getElementById('pointsText');
          el.addEventListener('markerFound', ()=>{
            console.log('markerFound');
            award('plant_tree'); // reward for scanning tree

            // show +points briefly
            pointsText.setAttribute('visible','true');
            setTimeout(()=>pointsText.setAttribute('visible','false'),1500);
          });
        }
      });
    </script>
  </body>
</html>
